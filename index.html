<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebAuthn SaaS æ•´åˆç¯„ä¾‹</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        max-width: 600px;
        margin: 40px auto;
        padding: 20px;
        line-height: 1.6;
      }
      h2 {
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
      }
      button {
        padding: 10px 20px;
        cursor: pointer;
        background-color: #0070f3;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        margin-right: 10px;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      button.secondary {
        background-color: #444;
      }
      #status {
        margin-top: 20px;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 4px;
        white-space: pre-wrap;
        word-break: break-all;
        font-family: monospace;
        font-size: 12px;
      }
      .success {
        color: green;
        border-left: 4px solid green;
      }
      .error {
        color: red;
        border-left: 4px solid red;
      }
    </style>
  </head>
  <body>
    <h2>WebAuthn ç”Ÿç‰©è¾¨è­˜ç™»å…¥ (SaaS æ¨¡å¼)</h2>
    <p>é€™æ˜¯æ‚¨çš„ç¶²ç«™ (Tenant) èˆ‡èº«åˆ†é©—è­‰ SaaS ä¸²æ¥çš„ç¯„ä¾‹ã€‚</p>

    <div class="form-group">
      <label for="username">ä½¿ç”¨è€…å¸³è™Ÿ (Username)</label>
      <input
        type="text"
        id="username"
        placeholder="user@example.com"
        value="testuser"
      />
    </div>

    <div class="form-group">
      <button onclick="handleRegister()">ğŸ–ï¸ è¨»å†ŠæŒ‡ç´‹/FaceID</button>
      <button class="secondary" onclick="handleLogin()">ğŸ”‘ ä½¿ç”¨æŒ‡ç´‹ç™»å…¥</button>
    </div>

    <div id="status">ç­‰å¾…æ“ä½œ...</div>

    <script>
      // ==========================================
      // 1. è¨­å®šå€ (Configuration)
      // ==========================================

      // æŒ‡å‘æ‚¨çš„ SaaS API ä½å€ (æœ¬åœ°é–‹ç™¼é€šå¸¸æ˜¯ localhost:3000)
      const API_BASE_URL = "https://webauthn.zeabur.app";

      // å®¢æˆ¶çš„ API Key (å¾ SaaS å¾Œå°å–å¾—)
      const API_KEY = "test_api_key";

      const statusDiv = document.getElementById("status");

      // ==========================================
      // 2. æ ¸å¿ƒæµç¨‹ï¼šè¨»å†Š (Registration)
      // ==========================================
      async function handleRegister() {
        const username = document.getElementById("username").value;
        if (!username) return alert("è«‹è¼¸å…¥ä½¿ç”¨è€…å¸³è™Ÿ");

        log("æ­£åœ¨é–‹å§‹è¨»å†Šæµç¨‹...", "info");

        try {
          // Step 1: å‘¼å« SaaS API å–å¾—æŒ‘æˆ° (Challenge)
          const beginRes = await fetch(`${API_BASE_URL}/register/begin`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-API-KEY": API_KEY,
            },
            body: JSON.stringify({ username }),
          });

          if (!beginRes.ok) throw new Error(await beginRes.text());
          const { options, internalUserId } = await beginRes.json();

          // Step 2: è½‰æ›è³‡æ–™ (Base64URL -> ArrayBuffer)
          // é€™æ˜¯æœ€é—œéµçš„ä¸€æ­¥ï¼Œå› ç‚º WebAuthn API åªæ¥å—äºŒé€²ä½è³‡æ–™
          options.challenge = base64UrlToBuffer(options.challenge);
          options.user.id = base64UrlToBuffer(options.user.id);
          if (options.excludeCredentials) {
            options.excludeCredentials.forEach((cred) => {
              cred.id = base64UrlToBuffer(cred.id);
            });
          }

          log("è«‹åœ¨è£ç½®ä¸Šé€²è¡Œç”Ÿç‰©è¾¨è­˜é©—è­‰...", "info");

          // Step 3: å–šèµ·ç€è¦½å™¨ WebAuthn
          const credential = await navigator.credentials.create({
            publicKey: options,
          });

          // Step 4: è½‰æ›å›å‚³è³‡æ–™ (ArrayBuffer -> Base64URL)
          // ç‚ºäº†é€é JSON å‚³å›ä¼ºæœå™¨ï¼Œå¿…é ˆæŠŠäºŒé€²ä½è½‰å›å­—ä¸²
          const credentialPayload = {
            id: credential.id,
            rawId: bufferToBase64Url(credential.rawId),
            response: {
              attestationObject: bufferToBase64Url(
                credential.response.attestationObject
              ),
              clientDataJSON: bufferToBase64Url(
                credential.response.clientDataJSON
              ),
            },
            type: credential.type,
          };

          // Step 5: å‚³å› SaaS API é€²è¡Œé©—è­‰
          const finishRes = await fetch(`${API_BASE_URL}/register/finish`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-API-KEY": API_KEY,
            },
            body: JSON.stringify({
              internalUserId, // å¸¶å› API çµ¦æˆ‘å€‘çš„ ID ä»¥ä¾¿è¿½è¹¤ Session
              credential: credentialPayload,
            }),
          });

          const result = await finishRes.json();
          if (result.verified) {
            log("âœ… è¨»å†ŠæˆåŠŸï¼è©²è£ç½®å·²ç¶å®šã€‚", "success");
          } else {
            throw new Error("ä¼ºæœå™¨é©—è­‰å¤±æ•—");
          }
        } catch (err) {
          log(`âŒ è¨»å†ŠéŒ¯èª¤: ${err.message}`, "error");
          console.error(err);
        }
      }

      // ==========================================
      // 3. æ ¸å¿ƒæµç¨‹ï¼šç™»å…¥ (Login)
      // ==========================================
      async function handleLogin() {
        const username = document.getElementById("username").value;
        if (!username) return alert("è«‹è¼¸å…¥ä½¿ç”¨è€…å¸³è™Ÿ");

        log("æ­£åœ¨é–‹å§‹ç™»å…¥æµç¨‹...", "info");

        try {
          // Step 1: å‘¼å« SaaS API å–å¾—æŒ‘æˆ°
          const beginRes = await fetch(`${API_BASE_URL}/login/begin`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-API-KEY": API_KEY,
            },
            body: JSON.stringify({ username }),
          });

          if (!beginRes.ok) throw new Error(await beginRes.text());
          const { options, internalUserId } = await beginRes.json();

          // Step 2: è½‰æ›è³‡æ–™
          options.challenge = base64UrlToBuffer(options.challenge);
          if (options.allowCredentials) {
            options.allowCredentials.forEach((cred) => {
              cred.id = base64UrlToBuffer(cred.id);
            });
          }

          log("è«‹é©—è­‰æŒ‡ç´‹/FaceID...", "info");

          // Step 3: å–šèµ· WebAuthn
          const credential = await navigator.credentials.get({
            publicKey: options,
          });

          // Step 4: è½‰æ›è³‡æ–™
          const credentialPayload = {
            id: credential.id,
            rawId: bufferToBase64Url(credential.rawId),
            response: {
              authenticatorData: bufferToBase64Url(
                credential.response.authenticatorData
              ),
              clientDataJSON: bufferToBase64Url(
                credential.response.clientDataJSON
              ),
              signature: bufferToBase64Url(credential.response.signature),
              userHandle: credential.response.userHandle
                ? bufferToBase64Url(credential.response.userHandle)
                : null,
            },
            type: credential.type,
          };

          // Step 5: å‚³å› SaaS API
          const finishRes = await fetch(`${API_BASE_URL}/login/finish`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-API-KEY": API_KEY,
            },
            body: JSON.stringify({
              internalUserId,
              credential: credentialPayload,
            }),
          });

          const result = await finishRes.json();
          if (result.verified) {
            log("ğŸ‰ ç™»å…¥æˆåŠŸï¼", "success");
          } else {
            throw new Error("ä¼ºæœå™¨é©—è­‰å¤±æ•—");
          }
        } catch (err) {
          log(`âŒ ç™»å…¥éŒ¯èª¤: ${err.message}`, "error");
          console.error(err);
        }
      }

      // ==========================================
      // 4. å·¥å…·å‡½å¼ (Utilities) - è™•ç† Base64URL è½‰æ›
      // ==========================================

      // å°‡ Base64URL å­—ä¸²è½‰æ›ç‚º ArrayBuffer (çµ¦ç€è¦½å™¨ç”¨)
      function base64UrlToBuffer(base64url) {
        const padding = "=".repeat((4 - (base64url.length % 4)) % 4);
        const base64 = (base64url + padding)
          .replace(/\-/g, "+")
          .replace(/_/g, "/");
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray.buffer;
      }

      // å°‡ ArrayBuffer è½‰æ›ç‚º Base64URL å­—ä¸² (çµ¦ API ç”¨)
      function bufferToBase64Url(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = "";
        for (let i = 0; i < bytes.byteLength; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return window
          .btoa(binary)
          .replace(/\+/g, "-")
          .replace(/\//g, "_")
          .replace(/=/g, "");
      }

      function log(msg, type) {
        const el = document.getElementById("status");
        el.innerText = msg;
        el.className =
          type === "success" ? "success" : type === "error" ? "error" : "";
      }
    </script>
  </body>
</html>
